<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Housing Liaison Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
    <style>
        :root {
            --glass-bg: rgba(20, 25, 35, 0.7);
            --glass-border: rgba(255, 255, 255, 0.12);
            --accent: #3facff;
            --danger: #ff453a;
            --success: #32d74b;
        }

        body {
            margin: 0;
            padding: 24px;
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", "Segoe UI", Roboto, sans-serif;
            background: linear-gradient(rgba(0,0,0,0.3), rgba(0,0,0,0.5)),
                        url('https://images.unsplash.com/photo-1544198365-f5d60b6d8190?q=80&w=2070&auto=format&fit=crop') no-repeat center center fixed;
            background-size: cover;
            min-height: 100vh;
            color: #ffffff;
            box-sizing: border-box;
            display: flex;
            justify-content: center;
        }

        /* --- Animations --- */
        @keyframes shake {
            0% { transform: rotate(0deg); }
            25% { transform: rotate(0.5deg); }
            75% { transform: rotate(-0.5deg); }
            100% { transform: rotate(0deg); }
        }
        @keyframes popIn {
            0% { transform: scale(0.9); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }

        .edit-mode .app-card {
            animation: shake 0.4s infinite ease-in-out;
            cursor: grab;
        }
        .edit-mode .app-card:active { cursor: grabbing; }

        /* --- Layout --- */
        .grid-container {
            max-width: 1280px;
            width: 100%;
            display: grid;
            grid-template-columns: 280px 1fr;
            grid-template-rows: auto 1fr;
            gap: 24px;
            z-index: 1;
        }

        .glass-panel {
            background: var(--glass-bg);
            backdrop-filter: blur(25px);
            -webkit-backdrop-filter: blur(25px);
            border: 1px solid var(--glass-border);
            border-radius: 24px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.4);
            padding: 24px;
            transition: transform 0.2s ease;
        }
        
        /* --- Header --- */
        .header {
            grid-column: 1 / -1;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 32px;
        }

        .greeting-area h1 { margin: 0; font-size: 2.2rem; font-weight: 700; letter-spacing: -0.5px; }
        .greeting-area p { margin: 4px 0 0 0; font-size: 0.95rem; color: rgba(255, 255, 255, 0.6); font-weight: 500; }

        .header-controls { display: flex; gap: 12px; align-items: center; }

        .pill-container {
            background: rgba(0,0,0,0.3);
            padding: 8px 16px;
            border-radius: 50px;
            display: flex;
            align-items: center;
            gap: 12px;
            border: 1px solid var(--glass-border);
            font-size: 0.9rem;
            font-weight: 500;
        }

        /* --- Buttons --- */
        button { font-family: inherit; }
        
        .action-btn {
            background: rgba(255,255,255,0.1);
            border: 1px solid var(--glass-border);
            color: white;
            padding: 10px 20px;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.2, 0.8, 0.2, 1);
            font-size: 0.95rem;
            font-weight: 600;
            display: flex; align-items: center; gap: 8px;
        }
        .action-btn:hover { background: rgba(255,255,255,0.2); transform: translateY(-1px); }
        .action-btn:active { transform: translateY(1px); }
        
        .btn-primary { background: var(--accent); color: #000; border: none; }
        .btn-primary:hover { background: #5bc0ff; }
        
        .edit-toggle-btn.active { background: var(--success); color: black; border-color: var(--success); }

        /* Hidden Layout Controls */
        .layout-controls {
            display: none;
            gap: 8px;
            animation: popIn 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
        }
        .edit-mode .layout-controls { display: flex; }
        
        .btn-save-layout { background: rgba(63, 172, 255, 0.2); color: #3facff; border: 1px solid rgba(63, 172, 255, 0.3); }
        .btn-save-layout:hover { background: rgba(63, 172, 255, 0.4); }
        
        .btn-reset-layout { background: rgba(255, 69, 58, 0.2); color: #ff453a; border: 1px solid rgba(255, 69, 58, 0.3); }
        .btn-reset-layout:hover { background: rgba(255, 69, 58, 0.4); }

        /* --- Sidebar --- */
        .sidebar { display: flex; flex-direction: column; gap: 24px; }
        .tool-title { 
            font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.15em; 
            color: var(--accent); margin-bottom: 16px; font-weight: 800; opacity: 0.9;
        }

        textarea { 
            width: 100%; height: 140px; border: 1px solid var(--glass-border); 
            background: rgba(0,0,0,0.2); color: white; border-radius: 16px; 
            padding: 16px; resize: none; outline: none; font-family: inherit; 
            box-sizing: border-box; line-height: 1.5;
        }
        textarea:focus { border-color: var(--accent); background: rgba(0,0,0,0.3); }

        .task-input { 
            width: 100%; padding: 14px; border: 1px solid var(--glass-border); 
            border-radius: 12px; background: rgba(0,0,0,0.2); color: white; 
            font-family: inherit; box-sizing: border-box; outline: none; margin-bottom: 15px; 
        }
        .task-input:focus { border-color: var(--accent); }

        .task-list { list-style: none; padding: 0; margin: 0; max-height: 400px; overflow-y: auto; }
        .task-item { 
            display: flex; align-items: center; padding: 12px 8px;
            border-bottom: 1px solid rgba(255,255,255,0.05); transition: opacity 0.2s;
            border-left: 3px solid transparent;
        }
        .task-item.priority-1 { border-left-color: var(--danger); background: rgba(255, 69, 58, 0.05); }
        .task-item.priority-2 { border-left-color: #ff9f0a; background: rgba(255, 159, 10, 0.05); }
        .task-item.priority-3 { border-left-color: var(--accent); background: rgba(63, 172, 255, 0.05); }

        .priority-badge {
            width: 14px; height: 14px; border-radius: 50%; display: flex; align-items: center; justify-content: center;
            font-size: 0.6rem; font-weight: 900; color: black; margin-right: 8px; flex-shrink: 0;
        }
        .priority-badge.p1 { background: var(--danger); }
        .priority-badge.p2 { background: #ff9f0a; }
        .priority-badge.p3 { background: var(--accent); }

        .task-text { flex-grow: 1; font-size: 0.95rem; cursor: pointer; }
        .task-done .task-text { text-decoration: line-through; opacity: 0.5; color: #888; }
        .delete-btn { background: none; border: none; color: #666; cursor: pointer; font-size: 1.2rem; padding: 0 10px; }
        .delete-btn:hover { color: var(--danger); }

        /* --- Main Content --- */
        .main-content { display: flex; flex-direction: column; gap: 32px; padding-bottom: 50px; }

        .category-container { position: relative; padding: 10px; border-radius: 20px; transition: background 0.2s; }
        .edit-mode .category-container { border: 2px dashed rgba(255,255,255,0.1); background: rgba(0,0,0,0.1); }
        
        .section-header {
            font-size: 1.2rem; font-weight: 600; color: white; margin-bottom: 20px;
            display: flex; align-items: center; gap: 10px; padding: 0 5px;
            justify-content: space-between;
        }

        .cat-controls { display: none; gap: 10px; }
        .edit-mode .cat-controls { display: flex; }
        .btn-icon { background: none; border: none; cursor: pointer; font-size: 1.1rem; opacity: 0.7; transition: all 0.2s; }
        .btn-icon:hover { opacity: 1; transform: scale(1.1); }

        .links-area {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 20px;
            min-height: 100px;
        }

        /* --- Cards --- */
        .app-card {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            text-align: center; height: 170px; text-decoration: none; color: #ffffff;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 22px;
            border: 1px solid var(--glass-border);
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            position: relative; padding: 15px; overflow: hidden;
        }
        
        .app-card:hover { 
            background: rgba(255, 255, 255, 0.12); 
            transform: translateY(-6px); 
            border-color: rgba(255,255,255,0.3); 
            box-shadow: 0 10px 30px rgba(0,0,0,0.3); 
        }

        .app-icon { font-size: 2.5rem; margin-bottom: 12px; filter: drop-shadow(0 4px 6px rgba(0,0,0,0.3)); }
        .app-name { font-weight: 600; font-size: 1rem; letter-spacing: 0.3px; }
        .app-desc { font-size: 0.75rem; color: rgba(255, 255, 255, 0.6); margin-top: 6px; line-height: 1.3; }

        .highlight-card { background: rgba(63, 172, 255, 0.1); border-color: rgba(63, 172, 255, 0.3); }
        .highlight-card:hover { background: rgba(63, 172, 255, 0.2); border-color: var(--accent); }
        
        .training-card { background: rgba(50, 215, 75, 0.08); border-color: rgba(50, 215, 75, 0.2); }
        .training-card:hover { background: rgba(50, 215, 75, 0.15); border-color: var(--success); }

        /* Edit Overlays */
        .card-edit-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(10, 10, 10, 0.85);
            display: none; flex-direction: column; align-items: center; justify-content: center;
            gap: 12px; z-index: 20; backdrop-filter: blur(4px);
        }
        .edit-mode .app-card:hover .card-edit-overlay { display: flex; animation: popIn 0.2s ease-out; }

        .btn-card-action { padding: 8px 16px; border-radius: 8px; border: none; font-weight: 600; cursor: pointer; font-size: 0.85rem; width: 80px; }
        .btn-edit { background: white; color: black; }
        .btn-del { background: rgba(255, 69, 58, 0.2); color: #ff453a; border: 1px solid #ff453a; }

        /* --- Modals --- */
        .modal-overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); z-index: 2000;
            align-items: center; justify-content: center;
            backdrop-filter: blur(12px);
        }

        .modal {
            background: #1c1c1e;
            padding: 32px;
            border-radius: 24px;
            border: 1px solid var(--glass-border);
            width: 420px;
            box-shadow: 0 40px 80px rgba(0,0,0,0.6);
            animation: popIn 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
        }
        
        .modal h2 { margin-top: 0; color: white; font-weight: 700; margin-bottom: 24px; }
        
        .form-group { margin-bottom: 18px; }
        .form-group label { display: block; color: rgba(255,255,255,0.5); font-size: 0.8rem; margin-bottom: 8px; font-weight: 500; text-transform: uppercase; letter-spacing: 0.05em; }
        .form-group input, .form-group select {
            width: 100%; padding: 12px;
            background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.1);
            border-radius: 10px; color: white; outline: none; font-size: 1rem;
            transition: border-color 0.2s;
        }
        .form-group input:focus, .form-group select:focus { border-color: var(--accent); background: rgba(255,255,255,0.12); }

        .modal-actions { display: flex; justify-content: flex-end; gap: 12px; margin-top: 30px; }
        .btn-secondary { background: transparent; color: white; border: 1px solid rgba(255, 255, 255, 0.2); padding: 10px 24px; border-radius: 10px; cursor: pointer; font-weight: 500; }
        .btn-secondary:hover { background: rgba(255,255,255,0.1); }
        
        .add-cat-btn {
            width: 100%; padding: 24px; border: 2px dashed rgba(255,255,255,0.2);
            background: transparent; color: rgba(255,255,255,0.5);
            border-radius: 20px; cursor: pointer; font-size: 1rem; font-weight: 600;
            display: none; transition: all 0.2s;
        }
        .add-cat-btn:hover { border-color: var(--accent); color: var(--accent); background: rgba(63, 172, 255, 0.05); }
        .edit-mode .add-cat-btn { display: block; }
        
        .add-link-card {
            display: none;
            border: 2px dashed rgba(255,255,255,0.15);
            background: transparent;
            justify-content: center; align-items: center;
            cursor: pointer; color: rgba(255,255,255,0.4);
            font-size: 2.5rem; font-weight: 200;
        }
        .add-link-card:hover { border-color: var(--accent); color: var(--accent); background: rgba(63, 172, 255, 0.05); }
        .edit-mode .add-link-card { display: flex; }

        /* --- Toast Notification --- */
        #toast {
            visibility: hidden;
            min-width: 250px;
            background-color: rgba(50, 50, 50, 0.9);
            color: #fff;
            text-align: center;
            border-radius: 50px;
            padding: 16px;
            position: fixed;
            z-index: 3000;
            left: 50%;
            bottom: 30px;
            transform: translateX(-50%) translateY(20px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            border: 1px solid rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            font-weight: 500;
            opacity: 0;
            transition: all 0.5s cubic-bezier(0.19, 1, 0.22, 1);
        }
        #toast.show {
            visibility: visible;
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }

    </style>
</head>
<body>

    <div class="grid-container">
        <div class="glass-panel header">
            <div class="greeting-area">
                <h1>Hello, Roza</h1>
                <p id="date-display">Loading...</p>
            </div>
            
            <div class="header-controls">
                <div class="pill-container">
                    <span>üìç Aloha, OR</span>
                    <span style="opacity:0.3;">|</span>
                    <span id="weather-display">--¬∞F</span>
                </div>

                <div class="layout-controls">
                    <button class="action-btn btn-save-layout" onclick="saveAsDefault()" title="Save current layout as your browser's default">
                        üíæ Save
                    </button>
                    <button class="action-btn btn-reset-layout" onclick="resetToDefault()" title="Reset to your saved default layout">
                        üîÑ Reset
                    </button>
                    <span style="opacity:0.3; margin:0 5px;">|</span>
                    <button class="action-btn" onclick="exportConfig()" title="Export configuration to a file">
                        üì§ Export
                    </button>
                    <button class="action-btn" onclick="document.getElementById('importFile').click()" title="Import configuration from a file">
                        üì• Import
                    </button>
                    <input type="file" id="importFile" style="display:none" onchange="importConfig(event)">
                    <span style="opacity:0.3; margin:0 5px;">|</span>
                </div>

                <button class="action-btn edit-toggle-btn" id="editBtn" onclick="toggleEditMode()">
                    ‚öôÔ∏è Configure
                </button>
            </div>
        </div>

        <div class="sidebar" id="sidebar">
            <!-- Widgets rendered here -->
        </div>

        <div class="main-content" id="mainContent">
            </div>

        <button class="add-cat-btn" onclick="openCatModal()">+ Add New Category Section</button>
    </div>

    <div id="toast">Notification</div>

    <div class="modal-overlay" id="linkModal">
        <div class="modal">
            <h2 id="modalTitle">Edit Link</h2>
            <div class="form-group">
                <label>Name</label>
                <input type="text" id="linkName" placeholder="e.g. HMIS Portal">
            </div>
            <div class="form-group">
                <label>URL</label>
                <input type="text" id="linkUrl" placeholder="https://...">
            </div>
            <div class="form-group">
                <label>Icon (Emoji)</label>
                <input type="text" id="linkIcon" placeholder="e.g. üè†">
            </div>
            <div class="form-group">
                <label>Description</label>
                <input type="text" id="linkDesc" placeholder="Brief subtitle...">
            </div>
            <div class="form-group">
                <label>Appearance</label>
                <select id="linkType">
                    <option value="standard">Standard (Glass)</option>
                    <option value="highlight">Highlight (Blue Tint)</option>
                    <option value="training">Training (Green Tint)</option>
                </select>
            </div>
            <div class="modal-actions">
                <button class="btn-secondary" onclick="closeModal('linkModal')">Cancel</button>
                <button class="action-btn btn-primary" onclick="saveLink()">Save Changes</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="catModal">
        <div class="modal">
            <h2>Section Settings</h2>
            <div class="form-group">
                <label>Section Title</label>
                <input type="text" id="catTitle">
            </div> 
             <div class="form-group">
                <label>Icon (Emoji)</label>
                <input type="text" id="catIcon">
            </div>
            <div class="modal-actions">
                <button class="btn-secondary" onclick="closeModal('catModal')">Cancel</button>
                <button class="action-btn btn-primary" onclick="saveCategory()">Save Changes</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="widgetModal">
        <div class="modal">
            <h2>Add New Widget</h2>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                <button class="action-btn" onclick="addWidget('notes')" style="flex-direction: column; height: 100px; gap: 4px;">
                    <span style="font-size: 1.5rem;">üìù</span><span>Notes</span>
                </button>
                <button class="action-btn" onclick="addWidget('tasks')" style="flex-direction: column; height: 100px; gap: 4px;">
                    <span style="font-size: 1.5rem;">‚úÖ</span><span>Tasks</span>
                </button>
                <button class="action-btn" onclick="addWidget('clock')" style="flex-direction: column; height: 100px; gap: 4px;">
                    <span style="font-size: 1.5rem;">üïí</span><span>Clock</span>
                </button>
                <button class="action-btn" onclick="addWidget('timer')" style="flex-direction: column; height: 100px; gap: 4px;">
                    <span style="font-size: 1.5rem;">‚è≥</span><span>Timer</span>
                </button>
                <button class="action-btn" onclick="addWidget('goal')" style="flex-direction: column; height: 100px; gap: 4px;">
                    <span style="font-size: 1.5rem;">üéØ</span><span>Goal</span>
                </button>
                <button class="action-btn" onclick="addWidget('quote')" style="flex-direction: column; height: 100px; gap: 4px;">
                    <span style="font-size: 1.5rem;">üí°</span><span>Quote</span>
                </button>
            </div>
            <div class="modal-actions">
                <button class="btn-secondary" onclick="closeModal('widgetModal')">Cancel</button>
            </div>
        </div>
    </div>

    <script>
        // --- Data & Initialization ---
        const defaultData = [
            {
                id: 'cat-1',
                title: "Sequoia Core Systems",
                icon: "üè¢",
                links: [
                    { id: 'l1', name: "HMIS", url: "https://wscs.wellsky.com/pdxmetroarea_hmis", icon: "üèòÔ∏è", desc: "WellSky Housing DB" },
                    { id: 'l2', name: "Credible", url: "https://login.crediblebh.com/", icon: "üè•", desc: "Clinical EHR" },
                    { id: 'l3', name: "PointClickCare", url: "https://secure.collectivemedical.com/", icon: "ü©∫", desc: "Care Coordination" },
                    { id: 'l4', name: "Paylocity", url: "https://access.paylocity.com/", icon: "üí∞", desc: "HR & Payroll" },
                    { id: 'l5', name: "PowerDMS", url: "https://powerdms.com/", icon: "üìÇ", desc: "Compliance & Docs" }
                ]
            },
            {
                id: 'cat-2',
                title: "Housing Search & Inventory",
                icon: "üè†",
                links: [
                    { id: 'l6', name: "My Apartment Map", url: "https://www.myapartmentmap.com/affordable_housing/", icon: "üó∫Ô∏è", desc: "Affordable Unit Maps", highlight: true },
                    { id: 'l7', name: "GoSection8", url: "https://www.gosection8.com/", icon: "üîë", desc: "Voucher Landlord DB", highlight: true },
                    { id: 'l8', name: "RENTCaf√© Portal", url: "https://www.rentcafe.com/housing/ra/portal/login", icon: "üèõÔ∏è", desc: "Waitlists & Portals", highlight: true },
                    { id: 'l9', name: "HUD Resource", url: "https://resources.hud.gov/", icon: "üá∫üá∏", desc: "Federal Housing Map" }
                ]
            },
            {
                id: 'cat-3',
                title: "Legal & Court Access",
                icon: "‚öñÔ∏è",
                links: [
                    { id: 'l10', name: "OJD Portal", url: "https://webportal.courts.oregon.gov/portal/Home/Dashboard/29", icon: "üèõÔ∏è", desc: "Oregon Judicial Case Search", highlight: true },
                    { id: 'l11', name: "MultCo Custody", url: "https://apps.mcso.us/PAID/Home/SearchResults", icon: "üöì", desc: "Multnomah Jail Search" },
                    { id: 'l12', name: "WashCo Custody", url: "https://webapps.washingtoncountyor.gov/custody/", icon: "üëÆ", desc: "Washington Co Jail Search" },
                    { id: 'l13', name: "Clear Clinic", url: "https://www.pcc.edu/clear-clinic/", icon: "‚ú®", desc: "Expungement Services" },
                    { id: 'l14', name: "Tenant Alliance", url: "https://www.oregoncat.org/", icon: "üõ°Ô∏è", desc: "Renters' Rights" }
                ]
            }
        ];

        // Load live data OR default data
        let rawData = JSON.parse(localStorage.getItem('roza_app_data')) || JSON.parse(JSON.stringify(defaultData));

        // Data structure migration & normalization
        let appData = {
            sections: Array.isArray(rawData) ? rawData : (rawData.sections || []),
            widgets: rawData.widgets || [
                { id: 'w-notes', type: 'notes', title: 'Quick Notes' },
                { id: 'w-tasks', type: 'tasks', title: 'Priority Tasks' }
            ]
        };
        
        let isEditing = false;
        let currentEditCatIdx = -1;
        let currentEditLinkIdx = -1;

        // Ensure IDs exist
        appData.sections.forEach((cat, i) => {
            if(!cat.id) cat.id = `cat-${i}-${Date.now()}`;
            cat.links.forEach((l, k) => { if(!l.id) l.id = `link-${i}-${k}-${Date.now()}`; });
        });

        // --- Core Render Logic ---
        function renderApp() {
            renderWidgets();
            const container = document.getElementById('mainContent');
            container.innerHTML = '';

            appData.sections.forEach((section, sIdx) => {
                const secEl = document.createElement('div');
                secEl.className = 'category-container';
                secEl.dataset.id = section.id;
                
                secEl.innerHTML = `
                    <div class="section-header">
                        <span>${section.icon} ${section.title}</span>
                        <div class="cat-controls">
                            <button class="btn-icon" onclick="openCatModal(${sIdx})">üìù</button>
                            <button class="btn-icon" style="color:#ff453a" onclick="deleteCategory(${sIdx})">üóëÔ∏è</button>
                        </div>
                    </div>
                `;

                const grid = document.createElement('div');
                grid.className = 'links-area';
                grid.dataset.catIndex = sIdx;

                section.links.forEach((link, lIdx) => {
                    const card = document.createElement('div'); 
                    let classes = `app-card ${link.highlight ? 'highlight-card' : ''} ${link.type === 'training' ? 'training-card' : ''}`;
                    
                    card.className = classes;
                    card.dataset.id = link.id;
                    
                    const clickAction = isEditing ? `onclick="event.preventDefault()"` : `onclick="window.open('${link.url}', '_blank')"`;
                    
                    card.innerHTML = `
                        <div class="app-icon">${link.icon}</div>
                        <div class="app-name">${link.name}</div>
                        <div class="app-desc">${link.desc}</div>
                        <div class="card-edit-overlay">
                            <button class="btn-card-action btn-edit" onclick="openLinkModal(${sIdx}, ${lIdx}); event.stopPropagation();">Edit</button>
                            <button class="btn-card-action btn-del" onclick="deleteLink(${sIdx}, ${lIdx}); event.stopPropagation();">Delete</button>
                        </div>
                    `;
                    
                    if (!isEditing) {
                        card.style.cursor = 'pointer';
                        card.onclick = () => window.open(link.url, '_blank');
                    }

                    grid.appendChild(card);
                });

                if (isEditing) {
                    const addBtn = document.createElement('div');
                    addBtn.className = 'app-card add-link-card';
                    addBtn.innerHTML = '+';
                    addBtn.onclick = () => openLinkModal(sIdx, -1);
                    grid.appendChild(addBtn);
                }

                secEl.appendChild(grid);
                container.appendChild(secEl);
            });

            initSortable();
        }

        // --- Widget Rendering ---
        function renderWidgets() {
            const sidebar = document.getElementById('sidebar');
            sidebar.innerHTML = '';

            appData.widgets.forEach((widget, wIdx) => {
                const widgetEl = document.createElement('div');
                widgetEl.className = 'glass-panel';
                widgetEl.dataset.id = widget.id;

                let contentHtml = '';
                if (widget.type === 'notes') {
                    contentHtml = `<textarea id="scratchpad" placeholder="Client updates, call logs..." oninput="saveNotes()">${localStorage.getItem('roza_notes') || ''}</textarea>`;
                } else if (widget.type === 'tasks') {
                    contentHtml = `
                        <input type="text" id="taskInput" class="task-input" placeholder="+ Add task (Enter)" onkeypress="handleTaskKey(event)">
                        <ul id="taskList" class="task-list">${localStorage.getItem('roza_tasks') || ''}</ul>
                    `;
                } else if (widget.type === 'clock') {
                    contentHtml = `<div id="widget-clock" style="font-size: 2.2rem; font-weight: 700; text-align: center; margin: 10px 0; color: var(--accent);">--:--:--</div>`;
                } else if (widget.type === 'timer') {
                    contentHtml = `
                        <div style="text-align: center;">
                            <div id="timer-display" style="font-size: 2.5rem; font-weight: 700;">25:00</div>
                            <div style="display: flex; gap: 8px; justify-content: center; margin-top: 10px;">
                                <button class="action-btn" onclick="toggleTimer(this)" style="padding: 6px 16px; font-size: 0.8rem;">Start</button>
                                <button class="action-btn" onclick="resetTimer()" style="padding: 6px 16px; font-size: 0.8rem;">Reset</button>
                            </div>
                        </div>
                    `;
                } else if (widget.type === 'goal') {
                    contentHtml = `<textarea id="dailyGoal" placeholder="What is your main focus today?" oninput="saveGoal()" style="height: 80px; font-size: 1rem; border-color: rgba(63, 172, 255, 0.3);">${localStorage.getItem('roza_goal') || ''}</textarea>`;
                } else if (widget.type === 'quote') {
                    const quote = quotes[Math.floor(Math.random() * quotes.length)];
                    contentHtml = `<div style="font-style: italic; font-size: 0.95rem; color: rgba(255,255,255,0.85); line-height: 1.5; padding: 10px 5px; text-align: center;">"${quote}"</div>`;
                }

                widgetEl.innerHTML = `
                    <div class="section-header" style="margin-bottom:12px; font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.15em; color: var(--accent); font-weight: 800;">
                        <span>${widget.title}</span>
                        ${isEditing ? `<button class="btn-icon" style="color:#ff453a; font-size:0.8rem" onclick="deleteWidget(${wIdx})">üóëÔ∏è</button>` : ''}
                    </div>
                    ${contentHtml}
                `;
                sidebar.appendChild(widgetEl);
            });

            if (isEditing) {
                const addWidgetBtn = document.createElement('button');
                addWidgetBtn.className = 'action-btn';
                addWidgetBtn.style.width = '100%';
                addWidgetBtn.style.justifyContent = 'center';
                addWidgetBtn.style.borderStyle = 'dashed';
                addWidgetBtn.style.background = 'transparent';
                addWidgetBtn.innerHTML = '+ Add Widget';
                addWidgetBtn.onclick = () => openWidgetModal();
                sidebar.appendChild(addWidgetBtn);
            }

            initWidgetSortable();
        }

        function initWidgetSortable() {
            const sidebar = document.getElementById('sidebar');
            new Sortable(sidebar, {
                animation: 250,
                disabled: !isEditing,
                ghostClass: 'sortable-ghost',
                onEnd: function (evt) {
                    const item = appData.widgets.splice(evt.oldIndex, 1)[0];
                    appData.widgets.splice(evt.newIndex, 0, item);
                    saveData();
                }
            });
        }

        function deleteWidget(idx) {
            if(!confirm("Remove this widget?")) return;
            appData.widgets.splice(idx, 1);
            saveData();
            renderApp();
        }

        function openWidgetModal() {
            document.getElementById('widgetModal').style.display = 'flex';
        }

        const quotes = [
            "Believe you can and you're halfway there.",
            "Your only limit is your mind.",
            "Focus on being productive instead of busy.",
            "The secret of getting ahead is getting started.",
            "Don't stop until you're proud.",
            "Small steps lead to big results.",
            "Make today amazing.",
            "Strive for progress, not perfection."
        ];

        function addWidget(type) {
            const titles = {
                notes: 'Quick Notes',
                tasks: 'Priority Tasks',
                clock: 'Digital Clock',
                timer: 'Focus Timer',
                goal: 'Today\'s Goal',
                quote: 'Daily Inspiration'
            };

            appData.widgets.push({
                id: `w-${type}-${Date.now()}`,
                type: type,
                title: titles[type] || 'New Widget'
            });

            saveData();
            closeModal('widgetModal');
            renderApp();
            showToast(`Added ${titles[type]}`);
        }

        // --- Drag & Drop ---
        function initSortable() {
            const mainContainer = document.getElementById('mainContent');
            const linkContainers = document.querySelectorAll('.links-area');

            new Sortable(mainContainer, {
                animation: 250,
                handle: '.section-header',
                disabled: !isEditing,
                ghostClass: 'sortable-ghost',
                onEnd: function (evt) {
                    const item = appData.sections.splice(evt.oldIndex, 1)[0];
                    appData.sections.splice(evt.newIndex, 0, item);
                    saveData();
                }
            });

            linkContainers.forEach(el => {
                new Sortable(el, {
                    group: 'shared-links',
                    animation: 250,
                    disabled: !isEditing,
                    onEnd: function (evt) {
                        const fromCatIdx = evt.from.dataset.catIndex;
                        const toCatIdx = evt.to.dataset.catIndex;
                        
                        if (fromCatIdx === toCatIdx && evt.oldIndex === evt.newIndex) return;

                        const item = appData.sections[fromCatIdx].links.splice(evt.oldIndex, 1)[0];
                        appData.sections[toCatIdx].links.splice(evt.newIndex, 0, item);
                        
                        saveData();
                        renderApp();
                    }
                });
            });
        }

        // --- LAYOUT MANAGEMENT (The New Features) ---
        function saveAsDefault() {
            const layoutStr = JSON.stringify(appData);
            localStorage.setItem('roza_default_layout', layoutStr);
            showToast("‚ú® Snapshot Saved as Default Layout");
        }

        function resetToDefault() {
            if(!confirm("Are you sure? This will overwrite your current layout with your saved Snapshot.")) return;
            
            const savedLayout = localStorage.getItem('roza_default_layout');
            if (savedLayout) {
                appData = JSON.parse(savedLayout);
                saveData(); // Update live data
                renderApp();
                showToast("‚Ü∫ Layout Reset to Snapshot");
            } else {
                showToast("‚ö†Ô∏è No saved snapshot found.");
            }
        }

        function showToast(message) {
            const toast = document.getElementById("toast");
            toast.innerText = message;
            toast.className = "show";
            setTimeout(function(){ toast.className = toast.className.replace("show", ""); }, 3000);
        }

        function exportConfig() {
            const dataStr = JSON.stringify(appData, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            const exportFileDefaultName = 'dashboard-config.json';

            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
            showToast("Configuration Exported");
        }

        function importConfig(e) {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    // Basic validation
                    if (importedData.sections || importedData.widgets) {
                        appData = {
                            sections: importedData.sections || appData.sections,
                            widgets: importedData.widgets || appData.widgets
                        };
                        saveData();
                        renderApp();
                        showToast("Configuration Imported");
                    } else {
                        alert("Invalid configuration file.");
                    }
                } catch (err) {
                    alert("Error parsing file.");
                }
            };
            reader.readAsText(file);
        }


        // --- Logic: CRUD ---
        function toggleEditMode() {
            isEditing = !isEditing;
            document.body.classList.toggle('edit-mode', isEditing);
            const btn = document.getElementById('editBtn');
            btn.classList.toggle('active', isEditing);
            btn.innerHTML = isEditing ? '‚úÖ Done' : '‚öôÔ∏è Configure';
            renderApp();
        }

        function deleteCategory(idx) {
            if (!confirm("Delete this category? Links will be moved to 'Unsorted'.")) return;
            
            const linksToSave = appData.sections[idx].links;
            appData.sections.splice(idx, 1);
            
            if (linksToSave.length > 0) {
                let unsorted = appData.sections.find(c => c.title === 'Unsorted');
                if (!unsorted) {
                    unsorted = { id: `cat-unsorted-${Date.now()}`, title: 'Unsorted', icon: 'üìÇ', links: [] };
                    appData.sections.push(unsorted);
                }
                unsorted.links.push(...linksToSave);
            }
            saveData();
            renderApp();
            showToast("Category Deleted");
        }

        function deleteLink(catIdx, linkIdx) {
            if(!confirm("Delete this link?")) return;
            appData.sections[catIdx].links.splice(linkIdx, 1);
            saveData();
            renderApp();
        }

        // --- Modals Logic ---
        function openLinkModal(catIdx, linkIdx) {
            currentEditCatIdx = catIdx;
            currentEditLinkIdx = linkIdx;
            
            const modal = document.getElementById('linkModal');
            const title = document.getElementById('modalTitle');
            
            if (linkIdx === -1) {
                title.innerText = "Add New Link";
                ['linkName','linkUrl','linkIcon','linkDesc'].forEach(id => document.getElementById(id).value = '');
                document.getElementById('linkType').value = 'standard';
            } else {
                title.innerText = "Edit Link";
                const link = appData.sections[catIdx].links[linkIdx];
                document.getElementById('linkName').value = link.name;
                document.getElementById('linkUrl').value = link.url;
                document.getElementById('linkIcon').value = link.icon;
                document.getElementById('linkDesc').value = link.desc;
                
                let typeVal = 'standard';
                if (link.highlight) typeVal = 'highlight';
                if (link.type === 'training') typeVal = 'training';
                document.getElementById('linkType').value = typeVal;
            }
            
            modal.style.display = 'flex';
        }

        function saveLink() {
            const name = document.getElementById('linkName').value;
            const url = document.getElementById('linkUrl').value;
            const icon = document.getElementById('linkIcon').value || 'üîó';
            const desc = document.getElementById('linkDesc').value;
            const type = document.getElementById('linkType').value;
            
            if (!name || !url) return alert("Name and URL required");

            const newLink = {
                id: currentEditLinkIdx === -1 ? `l-${Date.now()}` : appData.sections[currentEditCatIdx].links[currentEditLinkIdx].id,
                name, url, icon, desc,
                highlight: type === 'highlight',
                type: type === 'training' ? 'training' : undefined
            };

            if (currentEditLinkIdx === -1) {
                appData.sections[currentEditCatIdx].links.push(newLink);
            } else {
                appData.sections[currentEditCatIdx].links[currentEditLinkIdx] = newLink;
            }
            
            saveData();
            closeModal('linkModal');
            renderApp();
            showToast("Link Saved");
        }

        function openCatModal(idx = -1) {
            currentEditCatIdx = idx;
            document.getElementById('catModal').style.display = 'flex';
            if (idx > -1) {
                document.getElementById('catTitle').value = appData.sections[idx].title;
                document.getElementById('catIcon').value = appData.sections[idx].icon;
            } else {
                document.getElementById('catTitle').value = '';
                document.getElementById('catIcon').value = '';
            }
        }

        function saveCategory() {
            const title = document.getElementById('catTitle').value;
            const icon = document.getElementById('catIcon').value || 'üìÅ';
            
            if (!title) return;

            if (currentEditCatIdx > -1) {
                appData.sections[currentEditCatIdx].title = title;
                appData.sections[currentEditCatIdx].icon = icon;
            } else {
                appData.sections.push({
                    id: `cat-${Date.now()}`,
                    title: title,
                    icon: icon,
                    links: []
                });
            }
            
            saveData();
            closeModal('catModal');
            renderApp();
        }

        function closeModal(id) {
            document.getElementById(id).style.display = 'none';
        }

        function saveData() {
            localStorage.setItem('roza_app_data', JSON.stringify(appData));
        }

        // --- Widget Specific Logic ---
        let timerInterval;
        let timeLeft = 25 * 60;
        let timerRunning = false;

        function toggleTimer(btn) {
            if (timerRunning) {
                clearInterval(timerInterval);
                btn.innerText = 'Start';
            } else {
                timerInterval = setInterval(() => {
                    timeLeft--;
                    updateTimerDisplay();
                    if (timeLeft <= 0) {
                        clearInterval(timerInterval);
                        alert("Time's up!");
                        resetTimer();
                    }
                }, 1000);
                btn.innerText = 'Pause';
            }
            timerRunning = !timerRunning;
        }

        function resetTimer() {
            clearInterval(timerInterval);
            timeLeft = 25 * 60;
            timerRunning = false;
            updateTimerDisplay();
            const btn = document.querySelector('#timer-display + div button');
            if (btn) btn.innerText = 'Start';
        }

        function updateTimerDisplay() {
            const display = document.getElementById('timer-display');
            if (!display) return;
            const mins = Math.floor(timeLeft / 60);
            const secs = timeLeft % 60;
            display.innerText = `${mins}:${secs.toString().padStart(2, '0')}`;
        }

        function saveGoal() {
            localStorage.setItem('roza_goal', document.getElementById('dailyGoal').value);
        }

        // --- Existing Utils (Weather, Time, Notes) ---
        function updateTime() {
            const now = new Date();
            const options = { weekday: 'long', month: 'long', day: 'numeric', hour: 'numeric', minute: '2-digit' };
            document.getElementById('date-display').innerText = now.toLocaleDateString('en-US', options);

            const widgetClock = document.getElementById('widget-clock');
            if (widgetClock) {
                widgetClock.innerText = now.toLocaleTimeString('en-US', { hour12: false });
            }
        }

        async function fetchWeather() {
            try {
                const res = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=45.4943&longitude=-122.8670&current_weather=true&temperature_unit=fahrenheit`);
                const data = await res.json();
                document.getElementById('weather-display').innerText = `${Math.round(data.current_weather.temperature)}¬∞F`;
            } catch (e) { document.getElementById('weather-display').innerText = "--¬∞F"; }
        }

        // Task & Note Persistence
        function loadTasks() {
            const list = document.getElementById('taskList');
            const pad = document.getElementById('scratchpad');
            const saved = localStorage.getItem('roza_tasks');
            if(saved && list) list.innerHTML = saved;
            const notes = localStorage.getItem('roza_notes');
            if(notes && pad) pad.value = notes;
        }

        function saveTasks() {
            const list = document.getElementById('taskList');
            if (list) localStorage.setItem('roza_tasks', list.innerHTML);
        }
        function saveNotes() {
            const pad = document.getElementById('scratchpad');
            if (pad) localStorage.setItem('roza_notes', pad.value);
        }

        function handleTaskKey(e) {
            if (e.key === 'Enter' && e.target.value.trim()) {
                const list = document.getElementById('taskList');
                let val = e.target.value;
                let priority = '';
                let time = '';

                // Parse !1, !2, !3
                const pMatch = val.match(/!([1-3])/);
                if (pMatch) {
                    priority = pMatch[1];
                    val = val.replace(pMatch[0], '').trim();
                }

                // Parse @time
                const tMatch = val.match(/@(\S+)/);
                if (tMatch) {
                    time = tMatch[1];
                    val = val.replace(tMatch[0], '').trim();
                }

                const li = document.createElement('li');
                li.className = `task-item ${priority ? 'priority-' + priority : ''}`;
                li.innerHTML = `
                    <div style="display:flex; flex-direction:column; flex-grow:1;">
                        <div style="display:flex; align-items:center;">
                            ${priority ? `<span class="priority-badge p${priority}">${priority}</span>` : ''}
                            <span class="task-text" onclick="toggleTask(this)">${val}</span>
                        </div>
                        ${time ? `<span style="font-size:0.75rem; color:var(--accent); margin-top:4px; opacity:0.8;">üïí ${time}</span>` : ''}
                    </div>
                    <button class="delete-btn" onclick="removeTask(this)">√ó</button>
                `;
                if (list) list.prepend(li);
                e.target.value = '';
                saveTasks();
            }
        }

        window.toggleTask = function(el) { el.closest('.task-item').classList.toggle('task-done'); saveTasks(); }
        window.removeTask = function(btn) { btn.closest('.task-item').remove(); saveTasks(); }

        // Start
        setInterval(updateTime, 1000);
        updateTime();
        fetchWeather();
        loadTasks();
        renderApp();
    </script>
</body>
</html>
